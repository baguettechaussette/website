name: Update Twitch followers (total only)

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      # Centralisation des secrets
      TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
      TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
      TWITCH_BROADCASTER_ID: ${{ secrets.TWITCH_BROADCASTER_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate secrets presence
        run: |
          missing=0
          for var in TWITCH_CLIENT_ID TWITCH_CLIENT_SECRET TWITCH_BROADCASTER_ID; do
            if [ -z "${!var}" ]; then
              echo "::error title=Missing secret::$var is not set"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then
            exit 1
          fi

      - name: Get App Access Token (client_credentials)
        run: |
          echo "Requesting access token..."
          RESP=$(curl -sS -X POST "https://id.twitch.tv/oauth2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$TWITCH_CLIENT_ID" \
            -d "client_secret=$TWITCH_CLIENT_SECRET" \
            -d "grant_type=client_credentials")

          if ! echo "$RESP" | jq -e .access_token >/dev/null; then
            echo "::group::Full response payload"
            echo "$RESP"
            echo "::endgroup::"
            echo "::error title=Token request failed::Missing access_token field"
            exit 1
          fi

          ACCESS_TOKEN=$(echo "$RESP" | jq -r '.access_token')
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"
          echo "✅ Token successfully retrieved"

      - name: Fetch followers total
        run: |
          echo "Fetching followers total for broadcaster_id=$TWITCH_BROADCASTER_ID ..."
          mkdir -p data

          RESP=$(curl -sS --fail-with-body \
            -H "Client-Id: $TWITCH_CLIENT_ID" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://api.twitch.tv/helix/channels/followers?broadcaster_id=$TWITCH_BROADCASTER_ID") || {
              echo "::error title=Twitch API request failed::Unable to fetch followers"
              exit 1
            }

          TOTAL=$(echo "$RESP" | jq -r '.total // 0')
          if ! [[ "$TOTAL" =~ ^[0-9]+$ ]]; then
            echo "::group::Full response payload"
            echo "$RESP"
            echo "::endgroup::"
            echo "::error title=Invalid response::Followers total not numeric"
            exit 1
          fi

          jq -n --arg now "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --argjson total "$TOTAL" \
            '{followers: $total, updated_at: $now}' > data/followers.json

          echo "✅ Followers total: $TOTAL"

      - name: Commit if changed
        run: |
          if ! git diff --quiet data/followers.json; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/followers.json
            git commit -m "chore: update followers (total: $(jq -r .followers data/followers.json))"
            git push
            echo "✅ Changes committed and pushed."
          else
            echo "No changes detected in followers.json."
          fi
